<PerkDefinitions xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                               xsi:noNamespaceSchemaLocation="PerkDefinitions.xsd">
   
   <!-- ███████████████████████████████████████████████████████████████ -->
   <!-- DLC2 -->
   <!-- ███████████████████████████████████████████████████████████████ -->

   <!-- ███████████████████████████████████████████████████████████████ -->
   <!-- WEAPONS -->
   <!-- ███████████████████████████████████████████████████████████████ -->

   <PerkDefinition Id="BloodDrinker">
      <TokenVariables>
         <TokenVariable Key="PerkStack" Value="Max(0,Threshold - Module.Buffer)"/>
         <TokenVariable Key="IsTargetIsolated" Value="TargetUnit.IsIsolated"/>
         <TokenVariable Key="Threshold" Value="2"/>
         <TokenVariable Key="DebuffDamage" Value="-35"/>
         <TokenVariable Key="PerkCanBeClean" Value="Module.Buffer2"/>
         <TokenVariable Key="TargetWasHit" Value="Module.Buffer3"/>
      </TokenVariables>
      <LocArguments>
         <LocArgument Value="Threshold" Style="KeyWordNb"/>
         <LocalizedArgument Value="SkillEffectName_MultiHit" Style="MultiHit"/>
         <LocArgument Value="3" Style="DamageNb" Prefix=" x"/>
         <LocArgument Value="DebuffDamage" Suffix="%" Style="BadNb"/>
      </LocArguments>
      <View>
         <CompendiumEntries>
            <CompendiumEntry Id="SkillEffect_MultiHit"/>
            <CompendiumEntry Id="GameConcept_Isolated"/>
         </CompendiumEntries>
         <DisplayInHUD>
            <Buffer Value="PerkStack"/>
            <Highlight>
               <IsTrue Value="PerkStack = 0"/>
               <IsTrue Value="Skill.IsFromItemWithTag('Claws')"/>
            </Highlight>
            <GreyOut>
               <IsFalse Value="PerkStack = 0"/>
            </GreyOut>
         </DisplayInHUD>
         <FeedbackActivationConditions>
            <IsTrue Value="PerkStack = 0"/>
         </FeedbackActivationConditions>
      </View>
      <Modules>
         <BufferModule>
            <Events>
               <Event EffectTime="OnStartNightTurnPlayable">
                  <Conditions>
                     <IsTrue Value="PerkStack = 0"/>
                  </Conditions>
                  <Actions>
                     <SetBufferTo BufferIndex="Buffer" Value="0"/>
                     <RefreshPerkActivationFeedback RefreshView="true"/>
                  </Actions>
               </Event>
               <Event EffectTime="OnTargetHit">
                  <Conditions>
                     <IsTrue Value="Skill.IsFromItemWithTag('Claws')"/>
                     <IsFalse Value="PerkStack = 0"/>
                     <IsTrue Value="IsTargetUnit"/>
                     <IsTrue Value="Skill.IsAttack"/>
                     <IsTrue Value="IsTargetIsolated"/>
                  </Conditions>
                  <Actions>
                     <IncreaseBuffer BufferIndex="Buffer" Value="1"/>
                     <RefreshPerkActivationFeedback RefreshView="true"/>
                  </Actions>
               </Event>
               <Event EffectTime="OnSkillCastBegin">
                  <Conditions>
                     <IsTrue Value="Skill.IsFromItemWithTag('Claws')"/>
                  </Conditions>
                  <Actions>
                     <SetBufferTo BufferIndex="Buffer3" Value="0"/>
                  </Actions>
               </Event>
               <Event EffectTime="OnSkillCastBegin">
                  <Conditions>
                     <IsTrue Value="PerkStack = 0"/>
                     <IsTrue Value="Skill.IsAttack"/>
                  </Conditions>
                  <Actions>
                     <SetBufferTo BufferIndex="Buffer2" Value="0"/>
                  </Actions>
               </Event>
               <!--At least one unit is hit when perk is active-->
               <Event EffectTime="OnTargetHit">
                  <Conditions>
                     <IsTrue Value="PerkStack = 0"/>
                     <IsTrue Value="IsTargetUnit"/>
                     <IsTrue Value="Skill.IsAttack"/>
                     <IsFalse Value="IsTargetIsolated"/>
                  </Conditions>
                  <Actions>
                     <DecreaseBuffer BufferIndex="Buffer2" Value="1"/>
                     <SetBufferTo BufferIndex="Buffer3" Value="1"/>
                  </Actions>
               </Event>
               <!--Revert cleanse if injured target hit-->
               <Event EffectTime="OnTargetHit">
                  <Conditions>
                     <IsTrue Value="Skill.IsFromItemWithTag('Claws')"/>
                     <IsTrue Value="PerkStack = 0"/>
                     <IsTrue Value="IsTargetUnit"/>
                     <IsTrue Value="Skill.IsAttack"/>
                     <IsTrue Value="IsTargetIsolated"/>
                  </Conditions>
                  <Actions>
                     <SetBufferTo BufferIndex="Buffer2" Value="99"/>
                     <SetBufferTo BufferIndex="Buffer3" Value="1"/>
                  </Actions>
               </Event>
               <!-- Data Reset-->
               <Event EffectTime="OnSkillCastEnd">
                  <Conditions>
                     <IsTrue Value="Skill.IsFromItemWithTag('Claws')"/>
                     <IsTrue Value="PerkStack = 0"/>
                     <IsTrue Value="Skill.IsAttack"/>
                     <IsFalse Value="PerkCanBeClean > 0"/>
                     <IsTrue Value="TargetWasHit = 1"/>
                  </Conditions>
                  <Actions>
                     <SetBufferTo BufferIndex="Buffer" Value="0"/>
                     <RefreshPerkActivationFeedback RefreshView="true"/>
                  </Actions>
               </Event>
               <Event EffectTime="OnStartProductionTurn">
                  <Actions>
                     <SetBufferTo BufferIndex="Buffer" Value="0"/>
                     <SetBufferTo BufferIndex="Buffer2" Value="0"/>
                  </Actions>
               </Event>
            </Events>
            <Effects>
               <AddSkillEffect>
                  <Conditions>
                     <IsTrue Value="Skill.IsFromItemWithTag('Claws')"/>
                     <IsTrue Value="PerkStack = 0"/>
                     <IsTrue Value="Skill.IsAttack"/>
                  </Conditions>
                  <SkillEffects>
                     <MultiHit HitsCount="3"/>
                  </SkillEffects>
               </AddSkillEffect>
               <SkillModifier ComputationStat="OverallDamage" Value="DebuffDamage">
                  <Conditions>
                     <IsTrue Value="Skill.IsFromItemWithTag('Claws')"/>
                     <IsTrue Value="PerkStack = 0"/>
                     <IsTrue Value="Skill.IsAttack"/>
                  </Conditions>
               </SkillModifier>
            </Effects>
         </BufferModule>
      </Modules>
   </PerkDefinition>


	<PerkDefinition Id="StrongThrow">
      
		<TokenVariables>
         <TokenVariable Key="PerkStacks" Value="Max(0,EnemiesHitThreshold - Module.Buffer)"/>
			<TokenVariable Key="EnemiesHitThreshold" Value="9"/>
			<TokenVariable Key="CanActivatePerk" Value="Module.Buffer3"/>
      </TokenVariables>
		<LocArguments>
             <LocArgument Value="EnemiesHitThreshold" Style="KeyWordNb"/>
               <LocalizedArgument Value="SkillEffectName_MultiHit" Style="MultiHit"/>
               <LocArgument Value="3" Style="DamageNb" Prefix=" x"/>
             <!--<LocArgument Prefix="+" Value="OverallDamageBonus" Suffix="%" Style="GoodNb"/>-->
             <LocArgument Value="PerkStacks" Interpreted="true" Style="KeyWordNb"/>
      </LocArguments>
		<View>
			<DisplayInHUD>
				<Buffer Value="PerkStacks"/>
				<GreyOut>
					<IsFalse Value="PerkStacks = 0"/>
				</GreyOut>
				<Highlight> 
					<IsTrue Value="PerkStacks = 0"/>
					<IsTrue Value="Skill.IsFromItemWithTag('Boomerang')"/>
				</Highlight>
			</DisplayInHUD>
			<FeedbackActivationConditions>
				<IsFalse Value="PerkStacks = EnemiesHitThreshold"/>
			</FeedbackActivationConditions>
		</View>
		<Modules>
			<BufferModule>
				<Events>
					<Event EffectTime="OnTargetHit">
						<Conditions>
							<IsTrue Value="Skill.IsFromItemWithTag('Boomerang')"/>
							<IsTrue Value="IsTargetUnit"/>
							<IsFalse Value="PerkStacks = 0"/>
							<IsTrue Value="CanActivatePerk = 0"/>
						</Conditions>
						<Actions>
							<IncreaseBuffer BufferIndex="Buffer" Value="1"/>
						</Actions>
					</Event>
					<Event EffectTime="OnSkillCastEnd">
						<Conditions>
							<IsTrue Value="Skill.IsFromItemWithTag('Boomerang')"/>
							<IsTrue Value="PerkStacks = 0"/>
							<!--<IsTrue Value="Module.Buffer2 ! 0"/>-->
							<IsTrue Value="CanActivatePerk = 1"/>
						</Conditions>
						<Actions>
							<SetBufferTo BufferIndex="Buffer" Value="0"/>
							<SetBufferTo BufferIndex="Buffer2" Value="0"/>
							<SetBufferTo BufferIndex="Buffer3" Value="0"/>
							<RefreshPerkActivationFeedback RefreshView="true"/>
						</Actions>
					</Event>
					<Event EffectTime="OnSkillCastEnd">
						<Conditions>
							<IsTrue Value="Skill.IsFromItemWithTag('Boomerang')"/>
							<IsTrue Value="PerkStacks = 0"/>
							<IsTrue Value="CanActivatePerk = 0"/>
						</Conditions>
						<Actions>
							<RefreshPerkActivationFeedback RefreshView="true"/>
							<SetBufferTo BufferIndex="Buffer3" Value="1"/>
						</Actions>
					</Event>
					<!-- Reset Journa -->
					<Event EffectTime="OnStartProductionTurn">
						<Actions>
							<SetBufferTo BufferIndex="Buffer" Value="0"/>
							<SetBufferTo BufferIndex="Buffer2" Value="0"/>
							<SetBufferTo BufferIndex="Buffer3" Value="0"/>
						</Actions>
					</Event>
				</Events>
				<Effects>
               <ReplaceItemSkill SkillIdReplacement="PreciseTargettingStrongThrow" SkillIdToReplace="PreciseTargetting" LinkedSkillIdForUsesPerTurn="PreciseTargetting">

                  <Conditions>

							<IsTrue Value="CanActivatePerk = 1"/>

                  </Conditions>

               </ReplaceItemSkill>

               <ReplaceItemSkill SkillIdReplacement="CrescentSwingStrongThrow" SkillIdToReplace="CrescentSwing" LinkedSkillIdForUsesPerTurn="CrescentSwing">

                  <Conditions>

							<IsTrue Value="CanActivatePerk = 1"/>

                  </Conditions>

               </ReplaceItemSkill>
               <ReplaceItemSkill SkillIdReplacement="PainfulSpinStrongThrow" SkillIdToReplace="PainfulSpin" LinkedSkillIdForUsesPerTurn="PainfulSpin">

                  <Conditions>

							<IsTrue Value="CanActivatePerk = 1"/>

                  </Conditions>

               </ReplaceItemSkill>

				</Effects>
			</BufferModule>
		</Modules>
	</PerkDefinition>



   <PerkDefinition Id="StrongThrowReserve">
      <TokenVariables>
         <TokenVariable Key="STStacks" Value="Module.Buffer"/>
         <TokenVariable Key="PerkRange" Value="10"/>
         <TokenVariable Key="SkillId" Value="StrongThrowSkill"/>
         <TokenVariable Key="SkillDamage" Value="BaseDamage + Floor(Owner.StunChanceModifier * StunPercentage)"/>
         <TokenVariable Key="StunPercentage" Value="1.4"/>
         <TokenVariable Key="BaseDamage" Value="50"/>
      </TokenVariables>
      <LocArguments>
         <LocArgument Value="PerkRange + Owner.SkillRangeModifier" Style="KeywordNb" Interpreted="true"/>
         <LocalizedArgument Prefix="SkillName_" Value="StrongThrowSkill" Style="Skill"/>
         <LocArgument Value="StunPercentage * 100" Suffix="%" Style="KeyWordNb" Interpreted="true"/>
         <StatArgument Stat="StunChanceModifier"/>
         <LocalizedArgument Prefix="SkillName_" Value="SkillId" Style="Skill"/>
         <LocArgument Value="SkillDamage" Interpreted="true" Style="Damage"/>
         <LocArgument Value="BaseDamage" Style="KeyWordNb"/>
         <LocalizedArgument Prefix="SkillName_" Value="PainfulSpin" Style="Skill"/>
      </LocArguments>
      <View>
         <DisplayInHUD>
            <Buffer Value="Module.Buffer"/>
            <Highlight>
               <IsTrue Value="STStacks > 0"/>
            </Highlight>
            <HoverDisplay>
               <HoverRange Range="PerkRange + Owner.SkillRangeModifier"/>
            </HoverDisplay>
         </DisplayInHUD>
         <SkillsToShow>
            <SkillToShow Id="StrongThrowSkill"/>
         </SkillsToShow>
      </View>
      <Modules>
         <BufferModule>
            <Events>
               <Event EffectTime="OnSkillCastEnd">
                  <Conditions>
                     <IsTrue Value="Skill.IsFromItemWithTag('Boomerang')"/>
                  </Conditions>
                  <Actions>
                     <SetBufferTo BufferIndex="Buffer" Value="BooleanChoice(Skill.IsSkillID('PainfulSpin'),2,1)"/>
                     <TriggerEffects/>
                  </Actions>
               </Event>
            </Events>
            <Effects>
               <CastSkill SkillId="StrongThrowSkill">
                  <PerkTargeting TargetingReference="Caster" TargetingMethod="ClosestTarget" Range="PerkRange + Owner.SkillRangeModifier" Amount="STStacks">
                     <DamageableTarget Type="Enemy"/>
                     <HasStatus StatusType="Stun"/>
                  </PerkTargeting>
               </CastSkill>
               <ResetBuffer ResetValue="0"/>
            </Effects>
         </BufferModule>
      </Modules>
   </PerkDefinition>

   <PerkDefinition Id="LifeLoan">
      <TokenVariables>
         <TokenVariable Key="DebuffSpellId" Value="CleansingSpore"/>
         <TokenVariable Key="PoisonedEnemies" Value="Ceil((Plague * (EnemyPoisonScaling + PoisonScalingOnLevel)) * (Owner.PoisonDamageModifier/100))"/>
         <TokenVariable Key="MagicDamageBonus" Value="Plague * ScalingMagicDamage"/>
         <TokenVariable Key="PoisonScalingOnLevel" Value="(Floor(Owner.Level/PerLevelHeroScale) * PoisonScalingLevelMultiplicative)"/>
         <TokenVariable Key="PlayerPoisonScalingOnHit" Value="0.25"/>
         <TokenVariable Key="PerLevelHeroScale" Value="3"/>

         <TokenVariable Key="ApplyStatusRange" Value="4"/>
         <TokenVariable Key="PoisonPlayerDuration" Value="3"/>
         
         <TokenVariable Key="Plague" Value="(Module.Buffer)"/>
      
         <TokenVariable Key="EnemyPoisonScaling" Value="3"/>
         <TokenVariable Key="PoisonScalingLevelMultiplicative" Value="1"/>
         <TokenVariable Key="ScalingMagicDamage" Value="1"/>
         <TokenVariable Key="BaseStackCost" Value="0"/>
         <TokenVariable Key="AdditionnalStackPerCost" Value="1"/>
         <TokenVariable Key="DurationPoisonEnemies" Value="2"/>
      </TokenVariables>
      <LocArguments>
         <LocArgument Value="AdditionnalStackPerCost" Style="GoodNb"/>
         <StatArgument Stat="ActionPointsTotal"/>
         <StatArgument Stat="ManaTotal"/>
         <LocalizedArgument Prefix="SkillName_" Value="CleansingSpores" Style="Skill"/>
         <LocArgument Value="Plague" Style="GoodNb" Interpreted="true"/>
         <StatusArgument Value="EnemyPoisonScaling" Style="GoodNb" Status="Poison" TurnsCount="DurationPoisonEnemies"/>
         <LocArgument Value="PoisonScalingLevelMultiplicative" Style="GoodNb" Prefix="+"/>
         <StatArgument Stat="MagicalDamage" Value="ScalingMagicDamage" DisplaySign="true"/>
         <StatusArgument Value="PoisonedEnemies" Style="GoodNb" Status="Poison" TurnsCount="DurationPoisonEnemies" Interpreted="true"/>
         <StatusArgument Value="Round(PoisonedEnemies*PlayerPoisonScalingOnHit)" Style="GoodNb" Status="Poison" TurnsCount="DurationPoisonEnemies" Interpreted="true"/>
         <LocArgument Value="PlayerPoisonScalingOnHit*100" Interpreted="true" Suffix="%" Style="KeywordNb"/>
         <LocArgument Value="PerLevelHeroScale" Style="KeywordNb"/>
      </LocArguments>
      <View>
         <CompendiumEntries>
            <CompendiumEntry Id="SkillEffect_Poison"/>
            <CompendiumEntry Id="SkillEffect_Purge"/>
         </CompendiumEntries>
         <DisplayInHUD>
            <Buffer Value="Plague"/>
         </DisplayInHUD>
      </View>
      <Modules>
         <BufferModule>
            <Events>
               <!-- Plague Calculation -->
               <Event EffectTime="OnSkillCastBegin">
                  <Conditions>
                     <IsFalse Value="Skill.IsSkillID('CleansingSpores')"/>
                     <IsTrue Value="Skill.IsFromItemWithTag('ManaFlower')"/>
                  </Conditions>
                  <Actions>
                     <IncreaseBuffer BufferIndex="Buffer" Value="BaseStackCost + (Skill.BaseActionPointsCost + Skill.BaseManaCost) * (AdditionnalStackPerCost)"/>
                  </Actions>
               </Event>
               <!-- Cleasing Spore Shit -->
               <Event EffectTime="OnSkillCastEnd">
                  <Conditions>
                     <IsTrue Value="Skill.IsSkillID('CleansingSpores')"/>
                     <IsTrue Value="Skill.IsFromItemWithTag('ManaFlower')"/>
                  </Conditions>
                  <Actions>
                     <TriggerEffects/>
                     <SetBufferTo BufferIndex="Buffer" Value="0"/>
                     <SetBufferTo BufferIndex="Buffer2" Value="0"/>
                  </Actions>
               </Event>
               <!-- Cleasing Spore Shit -->
               <Event EffectTime="OnStartNightTurnEnemy">
                  <Actions>
                     <SetBufferTo BufferIndex="Buffer2" Value="1"/>
                  </Actions>
               </Event>
               
               <Event EffectTime="OnHitTaken">
                  <Conditions>
                     <IsTrue Value="Skill.IsAttack"/>
                     <IsTrue Value="IsEnemyTurn"/>
                  </Conditions>
                  <Actions>
                     <TriggerEffects/>
                     <SetBufferTo BufferIndex="Buffer" Value="0"/>
                  </Actions>
               </Event>

               <Event EffectTime="OnStartNightTurnPlayable">
                  <Actions>
                     <SetBufferTo BufferIndex="Buffer2" Value="0"/>
                  </Actions>
               </Event>
               <!-- Daily Reset -->
               <Event EffectTime="OnStartProductionTurn">
                  <Actions>
                     <SetBufferTo BufferIndex="Buffer" Value="0"/>
                  </Actions>
               </Event>
            </Events>
            <Effects>
               <StatModifier Stat="MagicalDamage" Value="MagicDamageBonus"/>

               <ApplyStatus Status="Poison" TurnsCount="DurationPoisonEnemies" Value="Round(PoisonedEnemies*PlayerPoisonScalingOnHit)">
                  <Conditions>
                     <IsTrue Value="Plague > 0"/>
                     <IsTrue Value="Module.Buffer2 = 1"/>
                  </Conditions>
                  <PerkTargeting Amount="1" Range="ApplyStatusRange" TargetingMethod="Self" TargetingReference="Owner">
                     <DamageableTarget Type="Playable"/>
                  </PerkTargeting>
               </ApplyStatus>

               <ApplyStatus Status="Poison" TurnsCount="DurationPoisonEnemies" Value="PoisonedEnemies">
                  <Conditions>
                     <IsTrue Value="Plague > 0"/>
                     <IsTrue Value="Module.Buffer2 = 1"/>
                  </Conditions>
                  <PerkTargeting Amount="99" Range="ApplyStatusRange" TargetingMethod="DamageablesInRange" TargetingReference="Owner">
                     <DamageableTarget Type="Enemy"/>
                     <DamageableTarget Type="Boss"/>
                  </PerkTargeting>
               </ApplyStatus>
               
               <CastSkill SkillId="BlankCleansingSpores">
                  <Conditions>
                     <IsTrue Value="Plague > 0"/>
                     <IsTrue Value="Module.Buffer2 = 1"/>
                  </Conditions>
                  <PerkTargeting Amount="1" Range="ApplyStatusRange" TargetingMethod="Self" TargetingReference="Owner">
                     <DamageableTarget Type="Playable"/>
                  </PerkTargeting>
               </CastSkill>

               <AddSkillEffect>
                  <Conditions>
                     <IsTrue Value="Plague > 0"/>
                     <IsTrue Value="Skill.IsSkillID('CleansingSpores')"/>
                  </Conditions>
                  <SkillEffects>
                     <SurroundingEffect>
                        <Poison>
                           <BaseChance>1</BaseChance>
                           <DamagePerTurn>PoisonedEnemies</DamagePerTurn>
                           <TurnsCount>DurationPoisonEnemies</TurnsCount>
                           <IgnorePoisonDamageScale/>
                        </Poison>
                     </SurroundingEffect>
                  </SkillEffects>
               </AddSkillEffect>
            </Effects>
         </BufferModule>
      </Modules>
   </PerkDefinition>


   <!-- ███████████████████████████████████████████████████████████████ -->
   <!-- RACE -->
   <!-- ███████████████████████████████████████████████████████████████ -->

   <PerkDefinition Id="IntoTheWild">
      <TokenVariables>
         <TokenVariable Key="MovePointReduction" Value="1"/>
         <TokenVariable Key="StatMalus" Value="-27"/>
         <TokenVariable Key="StatBonus" Value="7"/>
         <TokenVariable Key="PerkNeedRefresh" Value="Module.Buffer ! IsInsideHaven"/>
         <TokenVariable Key="IsInsideHaven" Value="BooleanChoice(Owner.IsInCity, 1, 0)"/>
         <TokenVariable Key="InsideHavenModifier" Value="BooleanChoice(Owner.IsInCity, 1, 0)"/>
         <TokenVariable Key="OutsideHavenModifier" Value="BooleanChoice(Owner.IsInCity, 0, 1)"/>
      </TokenVariables>
      <LocArguments>
         <LocalizedArgument Prefix="SkillName_" Value="JumpOverWall" Style="Skill"/>
         <LocArgument Prefix="-" Value="MovePointReduction" Style="GoodNb"/>
         <StatArgument Stat="MovePointsTotal"/>
         <StatArgument Stat="OverallDamage" Value="StatMalus"/>
         <StatArgument Stat="Accuracy" Value="StatBonus"/>
      </LocArguments>
      <View>
         <DisplayInHUD>
            <GreyOut>
               <IsTrue Value="IsInsideHaven = 1"/>
            </GreyOut>
            <HoverDisplay>
               <HavenArea/>
            </HoverDisplay>
         </DisplayInHUD>
         <FeedbackActivationConditions>
            <IsTrue Value="IsInsideHaven = 0"/>
         </FeedbackActivationConditions>
      </View>
      <Modules>
         <BufferModule>
            <Conditions>
               <IsTrue Value="Owner.IsInWorld"/>
            </Conditions>
            <Events>
               <!-- Init on unit spawn -->
               <Event EffectTime="OnUnitSpawned">
                  <Actions>
                     <SetBufferTo BufferIndex="Buffer" Value="IsInsideHaven"/>
                     <RefreshPerkActivationFeedback RefreshView="false"/>
                  </Actions>
               </Event>
               
               <Event EffectTime="OnMovementEnd">
                  <Conditions>
                     <IsTrue Value="IsInsideHaven = 0"/><!-- OUT OF HAVEN-->
                     <IsTrue Value="PerkNeedRefresh"/>
                  </Conditions>
                  <Actions>
                     <SetBufferTo BufferIndex="Buffer" Value="IsInsideHaven"/>
                     <RefreshPerkActivationFeedback RefreshView="true"/>
                     <InstantiateStatEffectDisplay Value="StatBonus" Stat="Accuracy"/>
                     <InstantiateStatEffectDisplay Value="StatMalus * -1" Stat="OverallDamage"/>
                  </Actions>
               </Event>
               <Event EffectTime="OnMovementEnd"> <!-- IN HAVEN-->
                  <Conditions>
                     <IsTrue Value="IsInsideHaven = 1"/>
                     <IsTrue Value="PerkNeedRefresh"/>
                  </Conditions>
                  <Actions>
                     <SetBufferTo BufferIndex="Buffer" Value="IsInsideHaven"/>
                     <RefreshPerkActivationFeedback RefreshView="true"/>
                     <InstantiateStatEffectDisplay Value="StatBonus * -1" Stat="Accuracy"/>
                     <InstantiateStatEffectDisplay Value="StatMalus" Stat="OverallDamage"/>
                  </Actions>
               </Event>
            </Events>
            <Effects>
               <StatModifier Stat="OverallDamage" Value="StatMalus * InsideHavenModifier"/>
               <StatModifier Stat="Accuracy" Value="StatBonus * OutsideHavenModifier"/>
               <ReplacePerk PerkToReplaceId="Leapfrog" PerkReplacementId="ElvenLeapfrog"/>
               <UnlockContextualSkill ContextualSkillId="ElvenJumpOverWall"/>
               <LockSkill SkillId="JumpOverWall"/>
            </Effects>
         </BufferModule>
      </Modules>
   </PerkDefinition>
   
      <PerkDefinition Id="ElvenLeapfrog">
      <TokenVariables>
         <TokenVariable Key="SkillId" Value="ElvenJumpOverWall2"/>
      </TokenVariables>
      <LocArguments>
         <LocalizedArgument Prefix="SkillName_" Value="JumpOverWall" Style="Skill"/>
      </LocArguments>
      <View>
         <DisplayInHUD/>
         <SkillsToShow>
            <SkillToShow Id="ElvenJumpOverWall2"/> <!-- TODO use "SkillId" TokenVariable if ever implemented-->
         </SkillsToShow>
      </View>
      <Modules>
         <BufferModule>
            <Effects>
               <LockSkill SkillId="JumpOverWall"/>
               <UnlockContextualSkill ContextualSkillId="ElvenJumpOverWall2"/>
               <LockSkill SkillId="ElvenJumpOverWall"/>
            </Effects>
         </BufferModule>
      </Modules>
   </PerkDefinition>
   
   <PerkDefinition Id="CoffeeInfused">
      <TokenVariables>
         <TokenVariable Key="SkillId" Value="ElvenCoffee"/>
         <TokenVariable Key="CurrentUses" Value="(1 + Floor(Owner.Level/LevelThreshold))"/>
         <TokenVariable Key="NbrUsePerLevel" Value="1"/>
         <TokenVariable Key="LevelThreshold" Value="4"/>
      </TokenVariables>
      <LocArguments>
         <LocalizedArgument Prefix="SkillName_" Value="SkillId" Style="Skill"/>
         <StatArgument DisplaySign="true" Stat="MovePointsTotal"/>
         <LocArgument Prefix="+" Style="GoodNb" Value="NbrUsePerLevel"/>
         <LocArgument Style="KeyWord" Value="LevelThreshold"/>
      </LocArguments>
      <View>
         <SkillsToShow>
            <SkillToShow Id="ElvenCoffee"/>
         </SkillsToShow>
         <DisplayBonusBeforePurchase/>
         <DisplayInHUD>
            <Buffer Value="CurrentUses"/>
            <GreyOut>
               <IsFalse Value="ContextualSkillActive"/>
            </GreyOut>
         </DisplayInHUD>
      </View>
      <Modules>
         <BufferModule>
            <Events>
               <Event EffectTime="OnExperienceDistributionEnded"> <!-- To trigger ModifyContextualSkillOverallUses effect -->
                  <Actions>
                     <TriggerEffects/>
                  </Actions>
               </Event>
            </Events>
            <Effects>
               <UnlockContextualSkill ContextualSkillId="ElvenCoffee" OverallUses="CurrentUses"/>
               <ModifyContextualSkillOverallUses ContextualSkillId="ElvenCoffee" OverallUses="CurrentUses" RefillOverallUses="true"/> <!-- not triggered on perk unlock -->
            </Effects>
         </BufferModule>
      </Modules>
   </PerkDefinition>
   
  <PerkDefinition Id="UrbanHate">
      <TokenVariables>
         
         <!-- Stat Calculation -->
         <TokenVariable Key="TotalManaRegenBonus" Value="(ManaRegenPerSteps * NumberOfStepsReached)"/>
         <TokenVariable Key="TotalXPBonus" Value="(XPBonusPerSteps * NumberOfStepsReached)"/>
         
         <!-- Tile Calculation -->
         <TokenVariable Key="NextThreshold" Value="(Floor((MinimumTilesThreshold + (NumberOfStepsReached + 1) * ComputedCityStep)/RoundingNumber)*RoundingNumber)"/>
         <TokenVariable Key="NumberOfStepsReached" Value="(Floor(TilesOverMinimumThreshold/ComputedCityStep))"/>
         <TokenVariable Key="ComputedCityStep" Value="(Round((TilesInCityNoIndestructibleBuilding*CityBonusStep)/RoundingNumber)*RoundingNumber)"/>
         <TokenVariable Key="TilesOverMinimumThreshold" Value="(Max(0, CityTilesActuallyAvailable - MinimumTilesThreshold))"/>
         <TokenVariable Key="MinimumTilesThreshold" Value="(Round((TilesInCityNoIndestructibleBuilding * MinimumThresholdPercentage)/RoundingNumber)*RoundingNumber)"/>
         <TokenVariable Key="CityTilesActuallyAvailable" Value="(TilesInCityNoBuilding)"/>
         <TokenVariable Key="CityBonusStep" Value="(0.04)"/>
         <TokenVariable Key="MinimumThresholdPercentage" Value="(0.70)"/>
         <TokenVariable Key="RoundingNumber" Value="(5)"/>
         
         <!-- Stat Base -->
         <TokenVariable Key="ManaRegenPerSteps" Value="2"/>
         <TokenVariable Key="XPBonusPerSteps" Value="8"/>
      </TokenVariables>
      <LocArguments>
         <LocArgument Value="ComputedCityStep" Interpreted="true" Style="KeywordNb"/>
         <LocArgument Value="MinimumTilesThreshold" Interpreted="true" Style="KeywordNb"/>
         <StatArgument Stat="ExperienceGainMultiplier" Value="XPBonusPerSteps" Interpreted="true"/>
         <StatArgument Stat="ManaRegen" Value="ManaRegenPerSteps" Interpreted="true"/>
         <LocArgument Value="CityTilesActuallyAvailable" Interpreted="true" Style="GoodNb"/>
         <LocArgument Value="NextThreshold" Interpreted="true" Style="GoodNb"/>
         <StatArgument Stat="ExperienceGainMultiplier" Value="TotalXPBonus" Interpreted="true"/>
         <StatArgument Stat="ManaRegen" Value="TotalManaRegenBonus" Interpreted="true"/>
      </LocArguments>
      <View>
         <DisplayInHUD>
            <Buffer Value="NumberOfStepsReached"/>
         </DisplayInHUD>
         <DisplayBonusBeforePurchase/>
      </View>
      <Modules>
         <BufferModule>
            <Effects>
               <StatModifier Stat="ExperienceGainMultiplier" Value="TotalXPBonus"/>
               <StatModifier Stat="ManaRegen" Value="TotalManaRegenBonus"/>
            </Effects>
         </BufferModule>
      </Modules>
   </PerkDefinition>
     
   <PerkDefinition Id="DeadlyRanger">
      <TokenVariables>
         <TokenVariable Key="TotalOneHandStat" Value="(Owner.OffHandEquippedItemsNumber + Owner.OneHandEquippedItemsNumber) * (BaseOneHandStatBonus + (Floor(Owner.Level/LevelThreshold) * OneHandStatMultiplier))"/>
         <TokenVariable Key="TotalTwoHandStat" Value="Owner.TwoHandEquippedItemsNumber * (BaseTwoHandsStatBonus + (Floor(Owner.Level/LevelThreshold) * TwoHandStatMultiplier))"/>
         <TokenVariable Key="OneHandStatMultiplier" Value="6"/>
         <TokenVariable Key="TwoHandStatMultiplier" Value="3"/>
         <TokenVariable Key="BaseOneHandStatBonus" Value="10"/>
         <TokenVariable Key="BaseTwoHandsStatBonus" Value="6"/>
         <TokenVariable Key="LevelThreshold" Value="5"/>
      </TokenVariables>
      <LocArguments>
         <StatArgument Stat="CriticalPower" Value="BaseOneHandStatBonus" Interpreted="true"/>
         <StatArgument Stat="Critical" Value="BaseTwoHandsStatBonus" Interpreted="true"/>
         <LocArgument Value="OneHandStatMultiplier" Suffix="%" Style="GoodNb" Interpreted="true"/>
         <LocArgument Value="TwoHandStatMultiplier" Suffix="%" Style="GoodNb" Interpreted="true"/>
         <StatArgument Stat="CriticalPower" Value="TotalOneHandStat" Interpreted="true"/>
         <StatArgument Stat="Critical" Value="TotalTwoHandStat" Interpreted="true"/>
         <LocalizedArgument Value="WeaponType_OneHand" Style="Keyword"/>
         <LocalizedArgument Value="WeaponType_TwoHands" Style="Keyword"/>
         <LocArgument Value="LevelThreshold" Style="KeywordNb"/>
      </LocArguments>
      <View>
         <DisplayBonusBeforePurchase/>
         <DisplayInHUD/>
      </View>
      <Modules>
         <BufferModule>
            <Effects>
               <StatModifier Stat="CriticalPower" Value="TotalOneHandStat"/>
               <StatModifier Stat="Critical" Value="TotalTwoHandStat"/>
            </Effects>
         </BufferModule>
      </Modules>
   </PerkDefinition>

   <PerkDefinition Id="Sentry">
      <TokenVariables>
         <TokenVariable Key="IsAnAllyInRange" Value="Owner.ClosestAllyDistance > AllyRange"/>
         <TokenVariable Key="AllyRange" Value="12"/>
      </TokenVariables>
      <LocArguments>
         <LocArgument Value="AllyRange" Style="KeyWordNb"/>
         <LocalizedArgument Value="SkillEffectName_IgnoreLineOfSight" Style="Vision"/>
      </LocArguments>
      <View>
         <DisplayInHUD>
            <GreyOut>
               <IsFalse Value="IsAnAllyInRange"/>
            </GreyOut>
            <HoverDisplay>
               <HoverRange Range="AllyRange"/>
            </HoverDisplay>
         </DisplayInHUD>
      </View>
      <Modules>
         <BufferModule>
            <Effects>
               <AddSkillEffect>
                  <Conditions>
                     <IsTrue Value="IsAnAllyInRange"/>
                  </Conditions>
                  <SkillEffects>
                     <IgnoreLineOfSight/>
                  </SkillEffects>
               </AddSkillEffect>
            </Effects>
         </BufferModule>
      </Modules>
   </PerkDefinition>

   <PerkDefinition Id="OneWithNature">
      <TokenVariables>
         <!-- Bonus Stat Stack -->
         <TokenVariable Key="BonusDamageTotal" Value="BooleanChoice(NumberOfStack > (BonusDamageUnlock - 1),Floor((BonusDamageBase * NumberOfStack)/(BonusDamageStep)),0)"/>
         <TokenVariable Key="BonusDodgeTotal" Value="BooleanChoice(NumberOfStack > (BonusDodgeUnlock - 1),Floor((BonusDodgeBase * NumberOfStack)/BonusDodgeStep),0)"/>
         <TokenVariable Key="BonusAPTotal" Value="BooleanChoice(NumberOfStack > (BonusAPUnlock - 1),Floor((BonusAPBase * NumberOfStack)/BonusAPStep),0)"/>
         
         <!-- Stack Gestion-->
         <TokenVariable Key="NumberOfStack" Value="(MaxSlotPossible - StackInverted)"/>
         <TokenVariable Key="StackInverted" Value="(Min(EquipedEquipement,MaxSlotPossible))"/>
         <TokenVariable Key="EquipedEquipement" Value="(Owner.OffHandEquippedItemsNumber + Owner.OneHandEquippedItemsNumber + (Owner.TwoHandEquippedItemsNumber*2) + Owner.ItemsNumberInSlot('ArmorSlot'))"/>
         <TokenVariable Key="MaxSlotPossible" Value="9"/>
      
         <!-- Stat Tokens-->
         <TokenVariable Key="BonusDamageBase" Value="5"/>
         <TokenVariable Key="BonusDamageStep" Value="1"/>
         <TokenVariable Key="BonusDamageUnlock" Value="1"/>
         <TokenVariable Key="BonusDodgeBase" Value="4"/>
         <TokenVariable Key="BonusDodgeStep" Value="1"/>
         <TokenVariable Key="BonusDodgeUnlock" Value="2"/>
         <TokenVariable Key="BonusAPBase" Value="1"/>
         <TokenVariable Key="BonusAPStep" Value="4"/>
         <TokenVariable Key="BonusAPUnlock" Value="4"/>
         <TokenVariable Key="BonusPunchUnlock" Value="9"/>
         <TokenVariable Key="BonusPunchDamage" Value="100"/>
      </TokenVariables>
      <LocArguments>
         <LocArgument Style="KeywordNb" Value="BonusDamageUnlock"/>
         <StatArgument Stat="OverallDamage" Value="BonusDamageBase" DisplaySign="true" Interpreted="true"/>
         <LocArgument Style="KeywordNb" Value="BonusDodgeUnlock"/>
         <StatArgument Stat="Dodge" Value="BonusDodgeBase" DisplaySign="true" Interpreted="true"/>
         <LocArgument Style="KeywordNb" Value="BonusAPUnlock"/>
         <StatArgument Stat="ActionPointsTotal" Value="BonusAPBase" DisplaySign="true" Interpreted="true"/>
         <LocArgument Style="KeywordNb" Value="BonusAPStep"/>
         <LocArgument Style="KeywordNb" Value="BonusPunchUnlock"/>
         <LocalizedArgument Prefix="SkillName_" Value="Punch" Style="Skill"/>
         <LocArgument Prefix="+" Style="GoodNb" Value="BonusPunchDamage" Suffix="%"/>
         <StatArgument Stat="OverallDamage" Value="BonusDamageTotal" Interpreted="true"/>
         <StatArgument Stat="Dodge" Value="BonusDodgeTotal" Interpreted="true"/>
         <StatArgument Stat="ActionPointsTotal" Value="BonusAPTotal" Interpreted="true"/>
         <LocArgument Style="KeyWordNb" Value="NumberOfStack" Interpreted="true"/>
      </LocArguments>
      <View>
         <DisplayInHUD>
            <Buffer Value="NumberOfStack"/>
         </DisplayInHUD>
      </View>
      <Modules>
         <BufferModule>
            <Effects>
               <StatModifier Stat="OverallDamage" Value="BonusDamageTotal" ChildStatFollows="true"/>
               <StatModifier Stat="Dodge" Value="BonusDodgeTotal"/>
               <StatModifier Stat="ActionPointsTotal" Value="BonusAPTotal"/>
               <SkillModifier ComputationStat="OverallDamage" Value="BonusPunchDamage">
                  <Conditions>
                     <IsTrue Value="NumberOfStack = 9"/>
                     <IsTrue Value="Skill.IsPunch"/>
                  </Conditions>
               </SkillModifier>
            </Effects>
         </BufferModule>
      </Modules>
   </PerkDefinition>

   <PerkDefinition Id="WeakSpotExploit">
      <TokenVariables>
         <TokenVariable Key="StunBonus" Value="20"/>
         <TokenVariable Key="PoisonDmg" Value="Round(40 * (Owner.PoisonDamageModifier/100))"/>
         <TokenVariable Key="PoisonDuration" Value="2"/>
         <!-- If IsTargetUnit + TargetUnit.HasNegativeAlteration are true OR Skill.HasNegativeAlteration is true, consider the perk as active 
         <TokenVariable Key="IsPerkActive" Value="BooleanChoice(IsTargetUnit, BooleanChoice(TargetUnit.HasNegativeAlteration, 1, BooleanChoice(Skill.HasNegativeAlteration, 1,0)), BooleanChoice(Skill.HasNegativeAlteration, 1,0))"/>
         -->
      </TokenVariables>
      <LocArguments>
         <StatArgument Stat="StunChanceModifier" Value="StunBonus"/>
         <StatusArgument Status="Poison" TurnsCount="PoisonDuration" Value="PoisonDmg" Interpreted="true" />
         <StatusArgument Status="AllNegative"/>
      </LocArguments>
      <View>
         <DisplayBonusBeforePurchase/>
         <DisplayInHUD>
            <Highlight>
               <!--<IsTrue Value="IsPerkActive"/>-->
               <IsTrue Value="IsTargetUnit"/>
               <IsTrue Value="TargetUnit.HasNegativeAlteration"/>
            </Highlight>
         </DisplayInHUD>
         <CompendiumEntries>
            <CompendiumEntry Id="SkillEffect_Poison"/>
            <CompendiumEntry Id="GameConcept_NegativeAlterations"/>
         </CompendiumEntries>
      </View>
      <Modules>
         <BufferModule>
            <Events>
               <Event EffectTime="OnTargetHitBeforeSkillEffectsApplied">
                  <Conditions>
                     <IsTrue Value="IsTargetUnit"/>
                     <IsTrue Value="TargetUnit.HasNegativeAlteration"/>
                  </Conditions>
                  <Actions>
                     <TriggerEffects/>
                  </Actions>
               </Event>
               <!-- A décommenter si on veut que WSE fonctionne aussi lorsqu'on applique un effet négatif à une cible qui en a déjà un. /!\ Ne pas oublier de l'ajouter dans le tooltip sur perk -->
               <!--<Event EffectTime="OnStatusApplied"> 
                  <Conditions>
                     <IsTrue Value="IsTargetUnit"/>
                     <IsTrue Value="TargetUnit.HasNegativeAlteration"/>
                  </Conditions>
                  <Actions>
                     <TriggerEffects/>
                  </Actions>
               </Event>-->
            </Events>
            <Effects>
               <ApplyStatus Status="Poison" TurnsCount="PoisonDuration" Value="PoisonDmg" HideDisplayEffect="true" RefreshHUD="false">
                  <PerkTargeting TargetingReference="Target" TargetingMethod="Self"/>
               </ApplyStatus>
               <StatModifier Stat="StunChanceModifier" Value="StunBonus"/>
            </Effects>
         </BufferModule>
      </Modules>
   </PerkDefinition>

   <PerkDefinition Id="Elusive">
      <TokenVariables>
         <TokenVariable Key="TransformedValue" Value="Floor(Owner.UnlockedArmorTotal * TransformedPercentage / 100)"/>
         <TokenVariable Key="TransformedPercentage" Value="30"/>
         <TokenVariable Key="ElusiveSkillRange" Value="5"/>
         <TokenVariable Key="ElusiveSkillBaseDamage" Value="10"/>
         <TokenVariable Key="ElusiveSkillScalingDamage" Value="50"/>
         <TokenVariable Key="ElusiveSkill2BaseDamage" Value="30"/>
         <TokenVariable Key="ElusiveSkill2ScalingDamage" Value="175"/>
      </TokenVariables>
      <LocArguments>
         <StatArgument Stat="ArmorTotal"/>
         <StatArgument Stat="Dodge"/>
         <StatArgument Stat="Dodge" Value="TransformedValue" Interpreted="true"/>
         <LocArgument Value="TransformedPercentage" Suffix="%" Style="KeyWordNb"/>
         <LocalizedArgument Prefix="SkillName_" Value="ElusiveSkill" Style="Skill"/>
         <LocArgument Value="ElusiveSkillRange" Style="KeyWordNb"/>
         <LocArgument Value="ElusiveSkillBaseDamage" Style="KeywordNb"/>
         <LocArgument Value="ElusiveSkillScalingDamage" Suffix="%" Style="KeywordNb"/>
         <LocalizedArgument Prefix="SkillName_" Value="ElusiveSkill2" Style="Skill"/>
         <LocArgument Value="ElusiveSkill2BaseDamage" Style="KeywordNb"/>
         <LocArgument Value="ElusiveSkill2ScalingDamage" Suffix="%" Style="KeywordNb"/>
         <LocArgument Value="ElusiveSkillBaseDamage + Floor(Owner.Dodge * (ElusiveSkillScalingDamage / 100))" Interpreted="true" Style="Damage"/>
         <LocArgument Value="ElusiveSkill2BaseDamage + Floor(Owner.Dodge * (ElusiveSkill2ScalingDamage / 100))" Interpreted="true" Style="Damage"/>
      </LocArguments>
      <View>
         <SkillsToShow>
            <SkillToShow Id="ElusiveSkill"/>
            <SkillToShow Id="ElusiveSkill2"/>
         </SkillsToShow>
         <DisplayBonusBeforePurchase/>
         <DisplayInHUD>
            <Bonus Value="TransformedValue"/>
         <HoverDisplay>
            <HoverRange Range="ElusiveSkillRange"/>
         </HoverDisplay>
         </DisplayInHUD>
      </View>
      <Modules>
         <BufferModule>
            <Events>
               <Event EffectTime="OnDodge">
                  <Actions>
                     <SetBufferTo BufferIndex="Buffer" Value="1"/>
                     <IncreaseBuffer BufferIndex="Buffer2" Value="1"/>
                     <RefreshPerkActivationFeedback/>
                  </Actions>
               </Event>
            <Event EffectTime="OnBehaviorClusterExecutionEnd">
               <Actions>
                  <TriggerEffects/>
                  <SetBufferTo BufferIndex="Buffer" Value="0"/>
                  <SetBufferTo BufferIndex="Buffer2" Value="0"/>
               </Actions>
            </Event>
               <Event EffectTime="OnStartNightTurnPlayable">
                  <Actions>
                     <SetBufferTo BufferIndex="Buffer" Value="0"/>
                     <SetBufferTo BufferIndex="Buffer2" Value="0"/>
                     <RefreshPerkActivationFeedback/>
                  </Actions>
               </Event>
            </Events>
            <Effects>
               <StatModifier Stat="Dodge" Value="TransformedValue"/>
               <StatLocker Stat="ArmorTotal"/>
               <CastSkill SkillId="ElusiveSkill2"> <!-- TODO use "SkillId" TokenVariable if ever implemented-->
                  <PerkTargeting TargetingReference="Owner" TargetingMethod="DamageablesInRange" Amount="Module.Buffer" Range="ElusiveSkillRange">
                     <DamageableTarget Type="Enemy"/>
                     <DamageableTarget Type="Boss"/>
                  </PerkTargeting>
               </CastSkill>
               <CastSkill SkillId="ElusiveSkill"> <!-- TODO use "SkillId" TokenVariable if ever implemented-->
                  <PerkTargeting TargetingReference="Owner" TargetingMethod="DamageablesInRange" Amount="Module.Buffer2 - Module.Buffer" Range="ElusiveSkillRange">
                     <DamageableTarget Type="Enemy"/>
                     <DamageableTarget Type="Boss"/>
                  </PerkTargeting>
               </CastSkill>
            </Effects>
         </BufferModule>
      </Modules>
   </PerkDefinition>

   <!-- T5 -->
   <PerkDefinition Id="WarDance">
      <TokenVariables>
         <TokenVariable Key="AutomaticSkill" Value="WarDanceSkill"/>
         <TokenVariable Key="SkillDamage" Value="BaseDamage + Floor(Owner.Dodge * (DodgePercentage / 100))"/>
         <TokenVariable Key="NbrOfEnemyHit" Value="Module.Buffer"/>
         <TokenVariable Key="RangeTargeting" Value="2"/>
         <TokenVariable Key="AmountOfTarget" Value="1"/>
         <TokenVariable Key="DodgePercentage" Value="90"/>
         <TokenVariable Key="BaseDamage" Value="25"/>
      </TokenVariables>
      <LocArguments>
         <LocalizedArgument Prefix="SkillName_" Value="WarDanceSkill" Style="Skill"/>
         <LocArgument Style="Keyword" Value="RangeTargeting"/>
         <LocArgument Style="KeywordNb" Value="BaseDamage"/>
         <LocArgument Style="KeywordNb" Value="DodgePercentage" Suffix="%"/>
         <LocArgument Value="SkillDamage" Interpreted="true" Style="Damage"/>
         <StatArgument Stat="Dodge"/>
      </LocArguments>
      <View>
         <DisplayInHUD>
            <HoverDisplay>
               <HoverRange Range="RangeTargeting"/>
            </HoverDisplay>
         </DisplayInHUD>
         <SkillsToShow>
            <SkillToShow Id="WarDanceSkill"/>
         </SkillsToShow>
      </View>
      <Modules>
         <BufferModule>
            <Events>
               <Event EffectTime="OnSkillCastBegin">
                  <Actions>
                     <SetBufferTo BufferIndex="Buffer" Value="0"/>
                  </Actions>
               </Event>
               <Event EffectTime="OnTargetHit">
                  <Actions>
                     <IncreaseBuffer BufferIndex="Buffer" Value="1"/>
                  </Actions>
               </Event>
               <Event EffectTime="OnSkillCastEnd">
                  <Conditions>
                     <IsTrue Value="NbrOfEnemyHit = 1"/>
                  </Conditions>
                  <Actions>
                     <TriggerEffects/>
                     <SetBufferTo BufferIndex="Buffer" Value="0"/>
                  </Actions>
               </Event>
            </Events>
            <Effects>
               <CastSkill SkillId="WarDanceSkill">
                  <PerkTargeting TargetingMethod="DamageablesInRange" TargetingReference="Owner" Amount="AmountOfTarget" Range="RangeTargeting">
                     <DamageableTarget Type="Enemy"/>
                     <DamageableTarget Type="Boss"/>
                  </PerkTargeting>
               </CastSkill>
            </Effects>
         </BufferModule>
      </Modules>
   </PerkDefinition>
      
   <PerkDefinition Id="HuntersArsenal">
      <TokenVariables>

         <!--Momentuml bonus calculation-->
         <TokenVariable Key="MomentumBonusTotal" Value="(MomentumBonusBase+(NumberOfStepsReached*MomentumBonusPerStep))/100"/>
         <TokenVariable Key="MomentumBonusPerStep" Value="3"/>
         <TokenVariable Key="MomentumBonusBase" Value="0"/> <!--Unused ! If set to 1 or more, needs to be added back to the localization key !-->

         <!--Poison bonus calculation-->
         <TokenVariable Key="PoisonBonusTotal" Value="(PoisonBonusBase+(NumberOfStepsReached*PoisonBonusPerStep))"/>
         <TokenVariable Key="PoisonBonusPerStep" Value="20"/>
         <TokenVariable Key="PoisonBonusBase" Value="0"/> <!--Unused ! If set to 1 or more, needs to be added back to the localization key !-->
         <TokenVariable Key="PoisonAppliedDuration" Value="2"/>
         
         <!--Range Damage Steps-->
         <TokenVariable Key="NextThreshold" Value="(MinimumRangedDamageThreshold + (NumberOfStepsReached + 1) * RangedDamageStep)"/>
         <TokenVariable Key="NumberOfStepsReached" Value="(Floor(CurrentRangedDamageOverThreshold / RangedDamageStep))"/>
         <TokenVariable Key="RangedDamageStep" Value="5"/>
         <TokenVariable Key="CurrentRangedDamageOverThreshold" Value="(Max(0, Owner.RangedDamage - MinimumRangedDamageThreshold))"/>
         <TokenVariable Key="MinimumRangedDamageThreshold" Value="100"/>
      </TokenVariables>
      <LocArguments>
         <StatArgument Stat="RangedDamage" Value="RangedDamageStep" DisplaySign="false" />
         <LocArgument Value="MinimumRangedDamageThreshold" Style="KeyWordNb"/>
         <AttackTypeArgument AttackType="Physical"/>
         <StatArgument Stat="MomentumAttacks" Value="MomentumBonusPerStep" DisplaySign="false"/>
         <AttackTypeArgument AttackType="Magical"/>
         <StatusArgument Status="Poison" Value="PoisonBonusPerStep" TurnsCount="PoisonAppliedDuration"/>
         <StatArgument Stat="MomentumAttacks" Value="MomentumBonusTotal * 100" DisplaySign="false" Interpreted="true"/>
         <StatusArgument Status="Poison" Value="PoisonBonusTotal" TurnsCount="PoisonAppliedDuration" Interpreted="true"/>
      </LocArguments>
      <View>
         <DisplayInHUD/>
         <DisplayBonusBeforePurchase/>
      </View>
      <Modules>
         <BufferModule>
            <Effects>
               <AddSkillEffect>
                  <Conditions>
                     <IsTrue Value="HasPerkData"/>
                     <IsTrue Value="Skill.IsAttack"/>
                     <IsTrue Value="Skill.IsPhysicalDamage"/>
                     <IsFalse Value="Skill.HasNativeMomentum"/>
                  </Conditions>
                  <SkillEffects>
                     <Momentum>
                        <DamageBonusPerTile>MomentumBonusTotal</DamageBonusPerTile>
                     </Momentum>
                  </SkillEffects>
               </AddSkillEffect>
               <AddSkillEffect>
                  <Conditions>
                     <IsTrue Value="HasPerkData"/>
                     <IsTrue Value="Skill.IsAttack"/>
                     <IsTrue Value="Skill.IsMagicalDamage"/>
                     <IsFalse Value="Skill.HasNativePoison"/>
                  </Conditions>
                  <SkillEffects>
                     <Poison>
                        <BaseChance>1</BaseChance>
                        <DamagePerTurn>PoisonBonusTotal</DamagePerTurn>
                        <TurnsCount>2</TurnsCount>
                        <IgnorePoisonDamageScale/>
                     </Poison>
                  </SkillEffects>
               </AddSkillEffect>
            </Effects>
         </BufferModule>
      </Modules>
   </PerkDefinition>

   <PerkDefinition Id="FlickerStrike">
      <TokenVariables>
         <TokenVariable Key="BaseDamage" Value="15"/>
         <TokenVariable Key="DamagePerStack" Value="8"/>
         <TokenVariable Key="SkillIsManeuverOrFollow" Value="BooleanChoice(Skill.HasManeuver,1,BooleanChoice(Skill.HasFollow,1,0))"/>
      </TokenVariables>
      <LocArguments>
         <LocalizedArgument Value="SkillEffectName_Follow" Style="Follow"/>
         <LocalizedArgument Value="SkillEffectName_Maneuver" Style="Maneuver"/>
         <LocArgument Value="BaseDamage" Prefix="+" Suffix="%" Style="GoodNb"/>
         <LocArgument Value="DamagePerStack" Suffix="%" Style="GoodNb"/>
      </LocArguments>
      <View>
         <DisplayInHUD>
            <Highlight>
               <IsTrue Value="SkillIsManeuverOrFollow = 1"/>
            </Highlight>
         </DisplayInHUD>
         <CompendiumEntries>
            <CompendiumEntry Id="SkillEffect_Maneuver"/>
            <CompendiumEntry Id="SkillEffect_Follow"/>
         </CompendiumEntries>
      </View>
      <Modules>
         <BufferModule>
            <Effects>
               <SkillModifier ComputationStat="OverallDamage" Value="BaseDamage + (DamagePerStack * DistanceFromOwnerToTargetUnit)">
                  <Conditions>
                     <IsTrue Value="HasPerkData"/>
                     <IsTrue Value="IsTargetUnit"/>
                     <IsTrue Value="Skill.IsAttack"/>
                     <IsTrue Value="SkillIsManeuverOrFollow = 1"/>
                  </Conditions>
               </SkillModifier>
            </Effects>
         </BufferModule>
      </Modules>
   </PerkDefinition>
   
   
   <!-- ███████████████████████████████████████████████████████████████ -->
   <!-- Trinket -->
   <!-- ███████████████████████████████████████████████████████████████ -->

   <PerkDefinition Id="ViciousKiller">
      <TokenVariables>
         <TokenVariable Key="SkillId" Value="ElvenFinishHim"/>
      </TokenVariables>
      <LocArguments>
         <LocalizedArgument Prefix="SkillName_" Value="SkillId" Style="Skill"/>
         <LocArgument Value="3" Style="KeywordNb"/>
      </LocArguments>
      <View>
         <SkillsToShow>
            <SkillToShow Id="ElvenFinishHim"/>
         </SkillsToShow>
         <DisplayBonusBeforePurchase/>
         <DisplayInHUD>
            <GreyOut>
               <IsFalse Value="ContextualSkillActive"/>
            </GreyOut>
         </DisplayInHUD>
      </View>
      <Modules>
         <BufferModule>
            <Effects>
               <UnlockContextualSkill ContextualSkillId="ElvenFinishHim"/>
            </Effects>
         </BufferModule>
      </Modules>
   </PerkDefinition>

   <PerkDefinition Id="MercyKill">
      <TokenVariables>
         <TokenVariable Key="ActionToRestore" Value="1"/>
         <TokenVariable Key="ActionMaxThreshold" Value="4"/>
         <TokenVariable Key="ActionRestoredThisTurn" Value="Module.Buffer"/>
      </TokenVariables>
      <LocArguments>
         <RestoreStatArgument Stat="ActionPointsTotal" Value="ActionToRestore"/>
         <LocArgument Value="ActionMaxThreshold" Style="KeywordNb"/>
      </LocArguments>
      <View>
         <DisplayInHUD>
            <Buffer Value="Max(0,ActionMaxThreshold-ActionRestoredThisTurn)"/>
            <GreyOut>
               <IsTrue Value="ActionRestoredThisTurn > ActionMaxThreshold - 1"/>
            </GreyOut>
            <Highlight>
               <IsFalse Value="ActionRestoredThisTurn > ActionMaxThreshold - 1"/>
               <IsTrue Value="Skill.IsAttack"/>
               <IsTrue Value="IsTargetUnit"/>
               <IsTrue Value="TargetUnit.WillDieByPoison"/>
            </Highlight>
         </DisplayInHUD>
      </View>
      <Modules>
         <BufferModule>
            <Events>
               <Event EffectTime="OnTargetKilled">
                  <Conditions>
                     <IsTrue Value="IsTargetUnit"/>
                     <IsTrue Value="TargetUnit.WillDieByPoison"/>
                     <IsFalse Value="ActionRestoredThisTurn > ActionMaxThreshold - 1"/>
                  </Conditions>
                  <Actions>
                     <IncreaseBuffer BufferIndex="Buffer" Value="1"/>
                     <TriggerEffects/>
                  </Actions>
               </Event>
               <Event EffectTime="OnStartNightTurnPlayable">
                  <Actions>
                     <SetBufferTo BufferIndex="Buffer" Value="0"/>
                  </Actions>
               </Event>
               <Event EffectTime="OnStartProductionTurn">
                  <Actions>
                     <SetBufferTo BufferIndex="Buffer" Value="0"/>
                  </Actions>
               </Event>
            </Events>
            <Effects>
               <RestoreStat Stat="ActionPoints" Value="ActionToRestore"/>
            </Effects>
         </BufferModule>
      </Modules>
   </PerkDefinition>


   <PerkDefinition Id="PlagueDoctor">
      <TokenVariables>
         <TokenVariable Key="BuffDuration" Value="2"/>
         <TokenVariable Key="BuffBaseValue" Value="8"/>
         <TokenVariable Key="TargetTouch" Value="Module.Buffer"/>
      </TokenVariables>
      <LocArguments>
         <StatusArgument Status="Contagion"/>
         <StatusArgument Status="Buff" Stat="PoisonDamageModifier" Value="BuffBaseValue" TurnsCount="BuffDuration" Interpreted="true"/>
      </LocArguments>
      <View>
         <DisplayInHUD/>
      </View>
      <Modules>
         <BufferModule>
            <Events>
               <Event EffectTime="OnStatusApplied">
                  <Conditions>
                     <IsTrue Value="IsPlayableTurn"/>
                     <IsTrue Value="IsTargetEnemyUnit"/>
                     <IsTrue Value="AppliedContagion"/>
                     <IsFalse Value="OwnerIsCaster"/>
                  </Conditions>
                  <Actions>
                     <IncreaseBuffer BufferIndex="Buffer" Value="1"/>
                  </Actions>
               </Event>
               <Event EffectTime="OnSkillCastEnd">
                  <Conditions>
                     <IsTrue Value="TargetTouch > 0"/>
                  </Conditions>
                  <Actions>
                     <TriggerEffects/>
                     <SetBufferTo BufferIndex="Buffer" Value="0"/>
                  </Actions>
               </Event>
            </Events>
            <Effects>
               <ApplyStatus Chance="100" Status="Buff" Stat="PoisonDamageModifier" TurnsCount="BuffDuration" Value="BuffBaseValue * TargetTouch">
                  <PerkTargeting Range="0" TargetingReference="Owner" TargetingMethod="Self"/>
               </ApplyStatus>
            </Effects>
         </BufferModule>
      </Modules>
   </PerkDefinition>

   <PerkDefinition Id="Longstrider">
      <TokenVariables>
         <TokenVariable Key="MomentumToAdd" Value="Floor(MomentumGainedPerSkill/MomentumThreshold)"/>
         <TokenVariable Key="MomentumThreshold" Value="2"/>
         <TokenVariable Key="MomentumGainedPerSkill" Value="Max(0 , FinishTile - StartingTile)"/>
         <TokenVariable Key="StartingTile" Value="Module.Buffer"/>
         <TokenVariable Key="FinishTile" Value="Module.Buffer2"/>
      </TokenVariables>
      <LocArguments>
         <LocArgument Value="MomentumThreshold" Style="GoodNb" />
         <LocalizedArgument Value="SkillEffectName_Momentum" Style="Momentum"/>
         <LocalizedArgument Value="SkillEffectName_Follow" Style="Follow"/>
         <LocalizedArgument Value="SkillEffectName_Maneuver" Style="Maneuver"/>
         <LocArgument Value="1" Style="GoodNb"/>
      </LocArguments>
      <View>
         <DisplayInHUD/>
         <CompendiumEntries>
            <CompendiumEntry Id="SkillEffect_Momentum"/>
            <CompendiumEntry Id="SkillEffect_Maneuver"/>
            <CompendiumEntry Id="SkillEffect_Follow"/>
         </CompendiumEntries>
      </View>
      <Modules>
         <BufferModule>
            <Events>
               <Event EffectTime="OnSkillCastBegin">
                  <Conditions>
                     <IsTrue Value="Skill.HasManeuver"/>
                     <IsFalse Value="Skill.HasNoMomentum"/>
                  </Conditions>
                  <Actions>
                     <SetBufferTo BufferIndex="Buffer" Value="Owner.TilesCrossedThisTurn"/>
                  </Actions>
               </Event>
               <Event EffectTime="OnSkillCastEnd">
                  <Conditions>
                     <IsTrue Value="Skill.HasManeuver"/>
                     <IsFalse Value="Skill.HasNoMomentum"/>
                  </Conditions>
                  <Actions>
                     <SetBufferTo BufferIndex="Buffer2" Value="Owner.TilesCrossedThisTurn"/>
                     <TriggerEffects/>
                  </Actions>
               </Event>
               <Event EffectTime="OnSkillCastBegin">
                  <Conditions>
                     <IsTrue Value="Skill.HasFollow"/>
                     <IsFalse Value="Skill.HasNoMomentum"/>
                  </Conditions>
                  <Actions>
                     <SetBufferTo BufferIndex="Buffer" Value="Owner.TilesCrossedThisTurn"/>
                  </Actions>
               </Event>
               <Event EffectTime="OnSkillCastEnd">
                  <Conditions>
                     <IsTrue Value="Skill.HasFollow"/>
                     <IsFalse Value="Skill.HasNoMomentum"/>
                  </Conditions>
                  <Actions>
                     <SetBufferTo BufferIndex="Buffer2" Value="Owner.TilesCrossedThisTurn"/>
                     <TriggerEffects/>
                  </Actions>
               </Event>
            </Events>
            <Effects>
               <MomentumModifier Value="MomentumToAdd"/>
               <ResetBuffer ResetValue="0"/>
            </Effects>
         </BufferModule>
      </Modules>
   </PerkDefinition>
      </PerkDefinitions>